<!DOCTYPE html> 
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Dave Laing - Cofree and comonad transformers</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="../css/custom.css">
        <link rel="stylesheet" href="../css/syntax.css">
        <link rel="alternate" type="application/atom+xml" title="Atom - Cofun with cofree comonads" href="../atom.xml" />
        <link rel="alternate" type="application/rss+xml" title="RSS - Cofun with cofree comonads" href="../rss.xml" />
    </head>
    <body>
        <nav class="navbar navbar-default navbar-static-top">
        <div class="container">
        <div class="navbar-header">
            <div class="navbar-brand">
                <a href="../">Cofun with cofree comonads</a>
            </div>
            <ul class="nav navbar-nav">
                <li role="presentation"><a href="http://dlaing.org">Back to my main site</a></li>
            </ul>
        </div>

        </div>
        </nav>

        <div class="container">
            <div class="panel panel-default">
    <div class="panel-heading">
        <h3 class="panel-title"><a href="../posts/cofree_and_comonad_transformers.html">Cofree and comonad transformers</a></h3>
    </div>
    <div class="panel-body">
        <h1 id="the-story-so-far">The story so far</h1>
<p><a href="../posts/free_and_cofree.html">Previously</a> we put together a DSL using the free monad and a corresponding interpreter using the cofree comonad.</p>
<p>Here is our code for the interpreter:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">CoAdder</span> <span class="fu">=</span> <span class="dt">Cofree</span> <span class="dt">CoAdderF</span>

<span class="ot">coAdd ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Bool</span>, (<span class="dt">Int</span>, <span class="dt">Int</span>))
coAdd (limit, count) x <span class="fu">=</span> (test, (limit, next))
  <span class="kw">where</span>
    count' <span class="fu">=</span> count <span class="fu">+</span> x
    test <span class="fu">=</span> count' <span class="fu">&lt;=</span> limit
    next <span class="fu">=</span> <span class="kw">if</span> test <span class="kw">then</span> count' <span class="kw">else</span> count

<span class="ot">coClear ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)
coClear (limit, _) <span class="fu">=</span> (limit, <span class="dv">0</span>)

<span class="ot">coTotal ::</span> (<span class="dt">Int</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> (<span class="dt">Int</span>, (<span class="dt">Int</span>, <span class="dt">Int</span>))
coTotal (limit, count) <span class="fu">=</span> (count, (limit, count))

<span class="ot">mkCoAdder ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">CoAdder</span> (<span class="dt">Int</span>, <span class="dt">Int</span>)
mkCoAdder limit count <span class="fu">=</span> coiter next start
  <span class="kw">where</span>
    next <span class="fu">=</span> <span class="dt">CoAdderF</span> <span class="fu">&lt;$&gt;</span> coAdd <span class="fu">&lt;*&gt;</span> coClear <span class="fu">&lt;*&gt;</span> coTotal
    start <span class="fu">=</span> (limit, count)</code></pre></div>
<p>There are a few different things going on here.</p>
<h1 id="cleaning-up-with-comonad-transformers">Cleaning up with comonad transformers</h1>
<p>There are two parts to what we’re doing that we can factor out so that we don’t have to manage them ourselves.</p>
<p>We are making use of <code>count</code> as a kind of state. If we were working in a monadic context, we’d reach for eitehr the <code>State</code> monad or <code>StateT</code> monad transformer. The comonad transformer equivalent is <code>Store/StoreT</code>.</p>
<p>We are making use of the <code>limit</code> as a kind of environment. Where a monadic version of the code would use <code>Reader/ReaderT</code>, the comonadic version will use <code>Env/EnvT</code>.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">class</span> <span class="dt">MonadTrans</span> t <span class="kw">where</span>
<span class="ot">  lift ::</span> w a <span class="ot">-&gt;</span> t w a</code></pre></div>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">class</span> <span class="dt">ComonadTrans</span> t <span class="kw">where</span>
<span class="ot">  lower ::</span> t w a <span class="ot">-&gt;</span> w a</code></pre></div>
<h2 id="setting-up-the-stack">Setting up the stack</h2>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">CoAdder</span> <span class="fu">=</span> <span class="dt">CoAdderT</span> <span class="dt">Base</span>
<span class="kw">type</span> <span class="dt">Base</span> <span class="fu">=</span> <span class="dt">StoreT</span> <span class="dt">Int</span> (<span class="dt">EnvT</span> <span class="dt">Int</span> <span class="dt">Identity</span>)
<span class="kw">type</span> <span class="dt">CoAdderT</span> <span class="fu">=</span> <span class="dt">CofreeT</span> <span class="dt">CoAdderF</span>

<span class="ot">mkCoAdder ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">CoAdder</span> ()
mkCoAdder limit count <span class="fu">=</span> coiterT next start
  <span class="kw">where</span>
    next <span class="fu">=</span> <span class="dt">CoAdderF</span> <span class="fu">&lt;$&gt;</span> coAdd <span class="fu">&lt;*&gt;</span> coClear <span class="fu">&lt;*&gt;</span> coTotal
    start <span class="fu">=</span> flip <span class="dt">StoreT</span> count <span class="fu">.</span> <span class="dt">EnvT</span> limit <span class="fu">.</span> <span class="dt">Identity</span> <span class="fu">$</span> const ()</code></pre></div>
<h2 id="introducing-storet">Introducing <code>StoreT</code></h2>
<p>TODO storet definition and operations, what they mean</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coClear ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> <span class="dt">Base</span> a
coClear <span class="fu">=</span> seek <span class="dv">0</span>

<span class="ot">coTotal ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Base</span> a)
coTotal w <span class="fu">=</span> (pos w, w)</code></pre></div>
<h2 id="introducting-envt">Introducting <code>EnvT</code></h2>
<p>TODO envt definition and operations, what they mean</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coAdd ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Bool</span>, <span class="dt">Base</span> a)
coAdd w x <span class="fu">=</span> (test, seek next w)
  <span class="kw">where</span>
    count <span class="fu">=</span> pos  w
    limit <span class="fu">=</span> ask <span class="fu">.</span> lower <span class="fu">$</span> w
    count' <span class="fu">=</span> count <span class="fu">+</span> x
    test <span class="fu">=</span> count' <span class="fu">&lt;=</span> limit
    next <span class="fu">=</span> <span class="kw">if</span> test <span class="kw">then</span> count' <span class="kw">else</span> count</code></pre></div>
<h2 id="the-hard-way">The hard way</h2>
<p>This was pretty easy, but it gets a little trickier if we change the order of the transformer stack.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">CoAdder</span> <span class="fu">=</span> <span class="dt">CoAdderT</span> <span class="dt">Base</span>
<span class="kw">type</span> <span class="dt">Base</span> <span class="fu">=</span> <span class="dt">EnvT</span> <span class="dt">Int</span> (<span class="dt">StoreT</span> <span class="dt">Int</span> <span class="dt">Identity</span>)
<span class="kw">type</span> <span class="dt">CoAdderT</span> <span class="fu">=</span> <span class="dt">CofreeT</span> <span class="dt">CoAdderF</span>

<span class="ot">mkCoAdder ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">CoAdder</span> ()
mkCoAdder limit count <span class="fu">=</span>
    coiterT next start
  <span class="kw">where</span>
    next <span class="fu">=</span> <span class="dt">CoAdderF</span> <span class="fu">&lt;$&gt;</span> coAdd <span class="fu">&lt;*&gt;</span> coClear <span class="fu">&lt;*&gt;</span> coTotal
    start <span class="fu">=</span> <span class="dt">EnvT</span> limit <span class="fu">.</span> flip <span class="dt">StoreT</span> count <span class="fu">.</span> <span class="dt">Identity</span> <span class="fu">$</span> const ()</code></pre></div>
<p>Since <code>seek s</code> is defined as <code>peek s . duplicate</code>, we need some fancier footwork to update the value in the <code>StoreT</code>:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coClear ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> <span class="dt">Base</span> a
coClear <span class="fu">=</span> peek <span class="dv">0</span> <span class="fu">.</span> lower <span class="fu">.</span> duplicate</code></pre></div>
<p>Getting access to <code>pos</code> just requires that we <code>lower</code> into the <code>StoreT</code> first:</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coTotal ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, <span class="dt">Base</span> a)
coTotal w <span class="fu">=</span> (pos <span class="fu">.</span> lower <span class="fu">$</span> w), w)

<span class="ot">coAdd ::</span> <span class="dt">Base</span> a <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Bool</span>, <span class="dt">Base</span> a)
coAdd w x <span class="fu">=</span> (test, peek next <span class="fu">.</span> lower <span class="fu">.</span> duplicate <span class="fu">$</span> w)
  <span class="kw">where</span>
    count <span class="fu">=</span> pos <span class="fu">.</span> lower <span class="fu">$</span> w
    limit <span class="fu">=</span> ask w
    count' <span class="fu">=</span> count <span class="fu">+</span> x
    test <span class="fu">=</span> count' <span class="fu">&lt;=</span> limit
    next <span class="fu">=</span> <span class="kw">if</span> test <span class="kw">then</span> count' <span class="kw">else</span> count</code></pre></div>
<h1 id="from-transformers-style-to-mtl-style">From <code>transformers</code> style to <code>mtl</code> style</h1>
<p>There are different schools of thoughts on whether to use <code>transformers</code> style monad transformers - in which you have concrete types and you use explicit lifts - or <code>mtl</code> style monad transformers - in which you use typeclass constraints and don’t have to lift anything.</p>
<p>I’m not going to take a strong stance here. With <code>transformers</code> your code is explicit and you can have multiple transformers of the same type in your stack. With <code>mtl</code> you can’t have multiple transformers of the same type, but you can write code that is decoupled from the concrete stack you end up using.</p>
<p>I lean slightly towards working with <code>mtl</code> style transformers, since I like the ease with which I can use it for prototyping and putting together pieces that I might reuse - even if the reuse is just between now and the next refactoring.</p>
<p>Anyhow.</p>
<p>What we have so far demonstrates <code>transformers</code> style comonad transformers. It might be instructive to show off the differences between that and <code>mtl</code> style comonad transformers.</p>
<p>The cases for <code>coClear</code> and <code>coTotal</code> don’t change except for the type signatures, since <code>StoreT</code> is at the top of our stack.</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coClear ::</span> <span class="dt">ComonadStore</span> <span class="dt">Int</span> w <span class="ot">=&gt;</span> w a <span class="ot">-&gt;</span> w a
coClear <span class="fu">=</span> seek <span class="dv">0</span>

<span class="ot">coTotal ::</span> <span class="dt">ComonadStore</span> <span class="dt">Int</span> w <span class="ot">=&gt;</span> w a <span class="ot">-&gt;</span> (<span class="dt">Int</span>, w a)
coTotal w <span class="fu">=</span> (pos w, w)</code></pre></div>
<p>For <code>coAdd</code> we make a similar change to the type signature, and we drop the explicit <code>lower</code>, since the <code>ComonadEnv</code> constraint makes <code>ask</code> available to us no matter where it is in the stack</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">coAdd ::</span> (<span class="dt">ComonadEnv</span> <span class="dt">Int</span> w, <span class="dt">ComonadStore</span> <span class="dt">Int</span> w) <span class="ot">=&gt;</span> w a <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> (<span class="dt">Bool</span>, w a)
coAdd w x <span class="fu">=</span> (test, seek next w)
  <span class="kw">where</span>
    count <span class="fu">=</span> pos w
    limit <span class="fu">=</span> ask w
    count' <span class="fu">=</span> count <span class="fu">+</span> x
    test <span class="fu">=</span> count' <span class="fu">&lt;=</span> limit
    next <span class="fu">=</span> <span class="kw">if</span> test <span class="kw">then</span> count' <span class="kw">else</span> count</code></pre></div>
<p>The mkCoadder code doesn’t change at all - and more importantly, the <code>coClear</code>, <code>coTotal</code> and <code>coAdd</code> methods don’t change even if we change the order in which we stack the transformers.</p>
<p>Both</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">CoAdderT</span> <span class="fu">=</span> <span class="dt">CofreeT</span> <span class="dt">CoAdderF</span>
<span class="kw">type</span> <span class="dt">CoAdder</span> <span class="fu">=</span> <span class="dt">CoAdderT</span> (<span class="dt">StoreT</span> <span class="dt">Int</span> (<span class="dt">EnvT</span> <span class="dt">Int</span> <span class="dt">Identity</span>))

<span class="ot">mkCoAdder ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">CoAdder</span> ()
mkCoAdder limit count <span class="fu">=</span>
    coiterT next start
  <span class="kw">where</span>
    next <span class="fu">=</span> <span class="dt">CoAdderF</span> <span class="fu">&lt;$&gt;</span> coAdd <span class="fu">&lt;*&gt;</span> coClear <span class="fu">&lt;*&gt;</span> coTotal
    start <span class="fu">=</span> flip <span class="dt">StoreT</span> count <span class="fu">.</span> <span class="dt">EnvT</span> limit <span class="fu">.</span> <span class="dt">Identity</span> <span class="fu">$</span> const ()</code></pre></div>
<p>and</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">CoAdderT</span> <span class="fu">=</span> <span class="dt">CofreeT</span> <span class="dt">CoAdderF</span>
<span class="kw">type</span> <span class="dt">CoAdder</span> <span class="fu">=</span> <span class="dt">CoAdderT</span> (<span class="dt">EnvT</span> <span class="dt">Int</span> (<span class="dt">StoreT</span> <span class="dt">Int</span> <span class="dt">Identity</span>))

<span class="ot">mkCoAdder ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">CoAdder</span> ()
mkCoAdder limit count <span class="fu">=</span>
    coiterT next start
  <span class="kw">where</span>
    next <span class="fu">=</span> <span class="dt">CoAdderF</span> <span class="fu">&lt;$&gt;</span> coAdd <span class="fu">&lt;*&gt;</span> coClear <span class="fu">&lt;*&gt;</span> coTotal
    start <span class="fu">=</span> <span class="dt">EnvT</span> limit <span class="fu">.</span> flip <span class="dt">StoreT</span> count <span class="fu">.</span> <span class="dt">Identity</span> <span class="fu">$</span> const ()</code></pre></div>
<p>will work without adjustments.</p>
<h1 id="conclusion">Conclusion</h1>
<p>We’ve now factored out the state and evnironment from the interpreter, but there are still aspects of both the DSL and the interpreter which are more strongly coupled than they need to be.</p>
    </div>
    
    <div class="panel-footer">
        <h5>Posted on May 24, 2015 </h5>
    </div>
    
</div>

            <div class="row">
                <div class="col-md-5"> Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a> </div>
                <div class="col-md-7">
                    This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>
                    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a>
                </div>
            </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59162164-1', 'auto');
  ga('send', 'pageview');
</script>

    </body>
</html>
